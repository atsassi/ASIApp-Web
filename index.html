<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ASIApp – Accesso</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Icona principale -->
  <link rel="icon" href="favicon.png" type="image/png">

  <!-- Stile principale -->
  <link rel="stylesheet" href="styles.css">

  <!-- Colore barra indirizzi (per mobile) -->
  <meta name="theme-color" content="#c9a227">
</head>

<body class="screen screen--splash">
  <div class="card card--center">
    <div class="logo">
      <img src="logo-toro.jpg" alt="ASI Investment" width="120" />
      <h1>ASI INVESTMENT</h1>
    </div>

    <h2>Accesso</h2>
    <form id="asiLogin" class="form">
      <label for="asiPass">Password ASI</label>
      <input type="password" id="asiPass" placeholder="••••••••" required />
      <button type="submit" class="btn btn--gold">Entra</button>

      <p class="help">
        Dimenticata? <a id="forgotLink" href="#">Recupero password</a>
      </p>
      <p id="lockMsg" class="error" style="display:none;"></p>
    </form>
  </div>

  <!-- Script principale -->
  <script src="script.js"></script>

  <!-- Logica di accesso -->
  <script>
    function initAsiLogin(config) {
      const form = document.getElementById("asiLogin");
      const passField = document.getElementById("asiPass");
      const lockMsg = document.getElementById("lockMsg");
      const forgot = document.getElementById("forgotLink");

      let attempts = 0;
      let locked = false;
      const lockMinutes = config.lockMinutes || 15;
      const maxAttempts = config.maxAttempts || 3;

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (locked) return;

        const value = passField.value.trim();
        if (value === config.password) {
          localStorage.setItem("asi_logged", "true");
          config.onSuccess();
        } else {
          attempts++;
          if (attempts >= maxAttempts) {
            locked = true;
            lockMsg.style.display = "block";
            lockMsg.textContent = `Troppe password errate. Riprova tra ${lockMinutes} minuti.`;
            setTimeout(() => {
              locked = false;
              attempts = 0;
              lockMsg.style.display = "none";
            }, lockMinutes * 60000);
          } else {
            alert(`Password errata. Tentativi rimasti: ${maxAttempts - attempts}`);
          }
        }
      });

      forgot.onclick = (e) => {
        e.preventDefault();
        config.onForgot();
      };
    }

    // Inizializzazione
    initAsiLogin({
      password: "asi2025",
      lockMinutes: 15,
      maxAttempts: 3,
      onSuccess: () => (window.location.href = "dashboard.html"),
      onForgot: () => {
        window.location.href =
          "mailto:atsassi@gmail.com?subject=Reset%20password%20ASIApp&body=Richiesta%20reset%20password%20per%20ASIApp.";
      },
    });
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("✅ Service Worker registrato"))
          .catch((err) => console.error("❌ Errore Service Worker:", err));
      });
    }
  </script>
</body>
</html>
